<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üßÆ AR Matrix Debug | –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç</title>
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
    
    <!-- WebXR Polyfill -->
    <script src="https://cdn.jsdelivr.net/npm/webxr-polyfill@latest/build/webxr-polyfill.min.js"></script>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #000;
            color: white;
            margin: 0;
            padding: 20px;
        }
        
        .start-btn {
            background: linear-gradient(45deg, #ff9800, #f57c00);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
        }
        
        .log {
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 10px;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
            border: 2px solid #ff9800;
            position: relative;
            z-index: 9999;
        }
        
        .hidden { display: none; }
        
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            color: #ff9800;
            padding: 10px;
            border-radius: 5px;
            font-size: 10px;
            z-index: 9999;
            max-width: 250px;
            border: 1px solid #ff9800;
        }
        
        .matrix {
            font-family: 'Courier New', monospace;
            font-size: 9px;
            color: #ffa726;
        }
        
        .controls {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
            z-index: 9999;
        }
        
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            background: #ff9800;
            color: white;
        }
    </style>
</head>
<body>
    <h1>üßÆ AR Matrix Debug</h1>
    <p>–ü–û–õ–ù–ê–Ø –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤—Å–µ—Ö –º–∞—Ç—Ä–∏—Ü –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç</p>
    
    <button id="start-btn" class="start-btn">
        üßÆ –ó–ê–ü–£–°–¢–ò–¢–¨ MATRIX DEBUG
    </button>
    
    <div id="log" class="log">
        üìù Matrix Debug –≥–æ—Ç–æ–≤...<br>
        üéØ –ü–æ–∫–∞–∂–µ–º –í–°–ï –º–∞—Ç—Ä–∏—Ü—ã –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã<br>
    </div>
    
    <div id="debug-panel" class="debug-panel hidden">
        <div id="debug-info">Debug info...</div>
    </div>
    
    <div id="controls" class="controls hidden">
        <button id="dump-matrices" class="btn">üìä DUMP MATRICES</button>
        <button id="test-render" class="btn">üé® TEST RENDER</button>
        <button id="toggle-wireframe" class="btn">üî≤ WIREFRAME</button>
    </div>

    <script>
        let session = null;
        let renderer = null;
        let scene = null;
        let camera = null;
        let referenceSpace = null;
        let frameCount = 0;
        let objects = [];
        let wireframeMode = false;
        let testScene = null;
        
        const log = document.getElementById('log');
        const debugPanel = document.getElementById('debug-panel');
        const debugInfo = document.getElementById('debug-info');
        const controls = document.getElementById('controls');

        function addLog(message) {
            console.log(message);
            log.innerHTML += message + '<br>';
            log.scrollTop = log.scrollHeight;
        }

        async function startMatrixDebug() {
            const startBtn = document.getElementById('start-btn');
            startBtn.disabled = true;
            startBtn.innerHTML = 'üîÑ –ó–∞–ø—É—Å–∫...';
            
            try {
                addLog('üßÆ === MATRIX DEBUG –ù–ê–ß–ê–¢ ===');
                addLog('üéØ –ü–æ–∫–∞–∂–µ–º –í–°–ï –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, –º–∞—Ç—Ä–∏—Ü—ã, —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏');
                
                // WebXR Polyfill
                if (window.WebXRPolyfill && !navigator.xr) {
                    const polyfill = new WebXRPolyfill();
                    addLog('üîß WebXR Polyfill –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
                }
                
                if (!navigator.xr) {
                    throw new Error('WebXR –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                }
                
                // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–∞—É–∑–µ—Ä–µ –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
                addLog('üì± === DEVICE INFO ===');
                addLog('User Agent: ' + navigator.userAgent.substring(0, 100));
                addLog('Platform: ' + navigator.platform);
                addLog('Pixel Ratio: ' + window.devicePixelRatio);
                addLog('Screen: ' + screen.width + 'x' + screen.height);
                addLog('Viewport: ' + window.innerWidth + 'x' + window.innerHeight);
                
                // –°–æ–∑–¥–∞–Ω–∏–µ AR —Å–µ—Å—Å–∏–∏
                session = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['local']
                });
                
                addLog('‚úÖ AR —Å–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞');
                addLog('Session: ' + JSON.stringify({
                    inputSources: session.inputSources.length,
                    visibilityState: session.visibilityState,
                    renderState: session.renderState ? 'exists' : 'null'
                }));
                
                // Reference space
                referenceSpace = await session.requestReferenceSpace('local');
                addLog('‚úÖ Local reference space –ø–æ–ª—É—á–µ–Ω');
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–Ω–¥–µ—Ä–µ—Ä–∞ —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
                await setupRendererWithDebug();
                setupSceneWithDebug();
                createDebugObjects();
                
                // –ó–∞–ø—É—Å–∫
                session.requestAnimationFrame(onXRFrame);
                
                startBtn.innerHTML = '‚úÖ MATRIX DEBUG –ê–ö–¢–ò–í–ï–ù';
                debugPanel.classList.remove('hidden');
                controls.classList.remove('hidden');
                
                setupControls();
                
                addLog('üéâ Matrix Debug –∑–∞–ø—É—â–µ–Ω!');
                addLog('üìä –°–º–æ—Ç—Ä–∏—Ç–µ –ø–∞–Ω–µ–ª—å —Å–ø—Ä–∞–≤–∞ –¥–ª—è live debug info');
                
            } catch (error) {
                addLog('‚ùå –û–®–ò–ë–ö–ê: ' + error.message);
                addLog('Stack: ' + error.stack);
                startBtn.disabled = false;
                startBtn.innerHTML = 'üßÆ –ó–ê–ü–£–°–¢–ò–¢–¨ MATRIX DEBUG';
            }
        }

        async function setupRendererWithDebug() {
            addLog('üîß === RENDERER DEBUG ===');
            
            const canvas = document.createElement('canvas');
            addLog('Canvas —Å–æ–∑–¥–∞–Ω: ' + canvas.width + 'x' + canvas.height);
            
            const gl = canvas.getContext('webgl', { 
                xrCompatible: true,
                alpha: true,
                antialias: true,
                depth: true,
                stencil: false,
                preserveDrawingBuffer: true, // –î–ª—è debug
                powerPreference: "high-performance"
            });
            
            if (!gl) {
                throw new Error('WebGL –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ —Å–æ–∑–¥–∞–Ω!');
            }
            
            addLog('WebGL –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–∑–¥–∞–Ω');
            addLog('WebGL –≤–µ—Ä—Å–∏—è: ' + gl.getParameter(gl.VERSION));
            addLog('WebGL vendor: ' + gl.getParameter(gl.VENDOR));
            addLog('WebGL renderer: ' + gl.getParameter(gl.RENDERER));
            addLog('WebGL extensions: ' + gl.getSupportedExtensions().length);
            
            // Three.js —Ä–µ–Ω–¥–µ—Ä–µ—Ä
            renderer = new THREE.WebGLRenderer({
                canvas: canvas,
                context: gl,
                alpha: true,
                antialias: true,
                logarithmicDepthBuffer: false,
                precision: "highp"
            });
            
            addLog('THREE.WebGLRenderer —Å–æ–∑–¥–∞–Ω');
            addLog('Renderer info: ' + JSON.stringify({
                autoUpdate: renderer.info.autoUpdate,
                programs: renderer.info.programs ? renderer.info.programs.length : 'null'
            }));
            
            // XR –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            renderer.xr.enabled = true;
            renderer.xr.setSession(session);
            renderer.setPixelRatio(window.devicePixelRatio);
            
            // –û—Ç–∫–ª—é—á–∞–µ–º some optimizations –¥–ª—è debug
            renderer.sortObjects = false;
            renderer.autoClear = true;
            
            addLog('XR –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã');
            
            // XR Base Layer
            const baseLayer = new XRWebGLLayer(session, gl, {
                antialias: true,
                depth: true,
                stencil: false,
                alpha: true,
                multiview: false
            });
            
            await session.updateRenderState({ baseLayer: baseLayer });
            
            addLog('XRWebGLLayer —Å–æ–∑–¥–∞–Ω');
            addLog('Framebuffer: ' + baseLayer.framebufferWidth + 'x' + baseLayer.framebufferHeight);
            addLog('Viewport: ' + JSON.stringify(baseLayer.getViewport ? 'supported' : 'not supported'));
            
            // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ WebGL capabilities
            addLog('üìä WebGL Capabilities:');
            addLog('- Max texture size: ' + gl.getParameter(gl.MAX_TEXTURE_SIZE));
            addLog('- Max viewport: ' + gl.getParameter(gl.MAX_VIEWPORT_DIMS));
            addLog('- Max vertex attribs: ' + gl.getParameter(gl.MAX_VERTEX_ATTRIBS));
            addLog('- Max varying vectors: ' + gl.getParameter(gl.MAX_VARYING_VECTORS));
        }

        function setupSceneWithDebug() {
            addLog('üé® === SCENE DEBUG ===');
            
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, 1, 0.01, 100);
            
            addLog('Scene —Å–æ–∑–¥–∞–Ω–∞, UUID: ' + scene.uuid);
            addLog('Camera —Å–æ–∑–¥–∞–Ω–∞: fov=' + camera.fov + ', near=' + camera.near + ', far=' + camera.far);
            
            // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ + –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
            const ambientLight = new THREE.AmbientLight(0xffffff, 2.0);
            scene.add(ambientLight);
            addLog('Ambient light –¥–æ–±–∞–≤–ª–µ–Ω (intensity: 2.0)');
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 3.0);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);
            addLog('Directional light –¥–æ–±–∞–≤–ª–µ–Ω (intensity: 3.0)');
            
            // Hemisphere light –¥–ª—è soft lighting
            const hemisphereLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
            scene.add(hemisphereLight);
            addLog('Hemisphere light –¥–æ–±–∞–≤–ª–µ–Ω');
            
            addLog('Scene setup –∑–∞–≤–µ—Ä—à–µ–Ω, children: ' + scene.children.length);
        }

        function createDebugObjects() {
            addLog('üì¶ === DEBUG OBJECTS ===');
            
            // 1. –ë–û–õ–¨–®–û–ô WIREFRAME –∫—É–± –≤ origin - –ë–ï–ó –º–∞—Ç–µ—Ä–∏–∞–ª–∞, —Ç–æ–ª—å–∫–æ edges
            const wireframeGeometry = new THREE.EdgesGeometry(new THREE.BoxGeometry(3, 3, 3));
            const wireframeMaterial = new THREE.LineBasicMaterial({ color: 0xffffff });
            const wireframeCube = new THREE.LineSegments(wireframeGeometry, wireframeMaterial);
            wireframeCube.position.set(0, 0, 0);
            scene.add(wireframeCube);
            objects.push({
                object: wireframeCube,
                name: 'wireframe-origin',
                type: 'wireframe'
            });
            addLog('‚úÖ Wireframe –∫—É–± –≤ origin (0, 0, 0)');
            
            // 2. –ü–†–û–°–¢–´–ï –¢–û–ß–ö–ò –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ
            const pointsGeometry = new THREE.BufferGeometry();
            const pointsPositions = new Float32Array([
                0, 0, -0.5,  // 50cm –ø–µ—Ä–µ–¥ origin
                0, 0, -1,    // 1m –ø–µ—Ä–µ–¥ origin
                0, 0, -2,    // 2m –ø–µ—Ä–µ–¥ origin
                1, 0, -1,    // —Å–ø—Ä–∞–≤–∞
                -1, 0, -1,   // —Å–ª–µ–≤–∞
                0, 1, -1,    // —Å–≤–µ—Ä—Ö—É
                0, -1, -1    // —Å–Ω–∏–∑—É
            ]);
            pointsGeometry.setAttribute('position', new THREE.BufferAttribute(pointsPositions, 3));
            
            const pointsMaterial = new THREE.PointsMaterial({ 
                color: 0xff0000, 
                size: 20,  // –ë–æ–ª—å—à–∏–µ —Ç–æ—á–∫–∏
                sizeAttenuation: false // –†–∞–∑–º–µ—Ä –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
            });
            const points = new THREE.Points(pointsGeometry, pointsMaterial);
            scene.add(points);
            objects.push({
                object: points,
                name: 'debug-points',
                type: 'points'
            });
            addLog('‚úÖ 7 –∫—Ä–∞—Å–Ω—ã—Ö —Ç–æ—á–µ–∫ –≤ –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏—è—Ö');
            
            // 3. COORDINATE AXES - –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é
            const axesHelper = new THREE.AxesHelper(2);
            scene.add(axesHelper);
            objects.push({
                object: axesHelper,
                name: 'axes',
                type: 'helper'
            });
            addLog('‚úÖ Coordinate axes (2m) –¥–æ–±–∞–≤–ª–µ–Ω—ã');
            
            // 4. –ü–†–û–°–¢–û–ô BASIC –∫—É–± —Å –û–ß–ï–ù–¨ —è—Ä–∫–∏–º–∏ —Ü–≤–µ—Ç–∞–º–∏
            const basicGeometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
            const basicMaterial = new THREE.MeshBasicMaterial({ 
                color: 0x00ffff,
                transparent: false,
                fog: false,
                depthTest: false, // –û—Ç–∫–ª—é—á–∞–µ–º depth test
                depthWrite: false // –û—Ç–∫–ª—é—á–∞–µ–º depth write
            });
            const basicCube = new THREE.Mesh(basicGeometry, basicMaterial);
            basicCube.position.set(0, 0, -1);
            basicCube.renderOrder = 1000; // –†–µ–Ω–¥–µ—Ä–∏–º –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ
            scene.add(basicCube);
            objects.push({
                object: basicCube,
                name: 'basic-cube',
                type: 'basic'
            });
            addLog('‚úÖ Basic –∫—É–± (no depth test) –≤ (0, 0, -1)');
            
            // 5. SCREEN-SPACE quad - –æ–±—ä–µ–∫—Ç –≤ —ç–∫—Ä–∞–Ω–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö
            const screenGeometry = new THREE.PlaneGeometry(0.2, 0.2);
            const screenMaterial = new THREE.MeshBasicMaterial({ 
                color: 0xffff00,
                transparent: true,
                opacity: 0.8,
                side: THREE.DoubleSide,
                depthTest: false,
                depthWrite: false
            });
            const screenQuad = new THREE.Mesh(screenGeometry, screenMaterial);
            screenQuad.position.set(0, 0, -0.3); // –û—á–µ–Ω—å –±–ª–∏–∑–∫–æ
            screenQuad.renderOrder = 999;
            scene.add(screenQuad);
            objects.push({
                object: screenQuad,
                name: 'screen-quad',
                type: 'screen'
            });
            addLog('‚úÖ Screen quad (–æ—á–µ–Ω—å –±–ª–∏–∑–∫–æ) –≤ (0, 0, -0.3)');
            
            addLog(`üìä –í—Å–µ–≥–æ debug –æ–±—ä–µ–∫—Ç–æ–≤: ${objects.length}`);
            addLog('üéØ –¢–∏–ø—ã: wireframe, points, helper, basic, screen');
        }

        function dumpMatrices(frame) {
            addLog('üßÆ === MATRIX DUMP ===');
            
            try {
                // Viewer pose
                const viewerPose = frame.getViewerPose(referenceSpace);
                if (viewerPose) {
                    const transform = viewerPose.transform;
                    addLog('üëÅÔ∏è Viewer Transform:');
                    addLog(`Position: (${transform.position.x.toFixed(3)}, ${transform.position.y.toFixed(3)}, ${transform.position.z.toFixed(3)})`);
                    addLog(`Orientation: (${transform.orientation.x.toFixed(3)}, ${transform.orientation.y.toFixed(3)}, ${transform.orientation.z.toFixed(3)}, ${transform.orientation.w.toFixed(3)})`);
                    
                    // Matrix
                    const matrix = transform.matrix;
                    addLog('Matrix:');
                    for (let i = 0; i < 4; i++) {
                        const row = [];
                        for (let j = 0; j < 4; j++) {
                            row.push(matrix[i * 4 + j].toFixed(3));
                        }
                        addLog(`[${row.join(', ')}]`);
                    }
                    
                    // Views
                    addLog('üëÅÔ∏è Views: ' + viewerPose.views.length);
                    viewerPose.views.forEach((view, index) => {
                        addLog(`View ${index}:`);
                        addLog(`  Eye: ${view.eye}`);
                        addLog(`  Transform: (${view.transform.position.x.toFixed(3)}, ${view.transform.position.y.toFixed(3)}, ${view.transform.position.z.toFixed(3)})`);
                        
                        const projMatrix = view.projectionMatrix;
                        addLog(`  Projection Matrix:`);
                        for (let i = 0; i < 4; i++) {
                            const row = [];
                            for (let j = 0; j < 4; j++) {
                                row.push(projMatrix[i * 4 + j].toFixed(3));
                            }
                            addLog(`    [${row.join(', ')}]`);
                        }
                    });
                } else {
                    addLog('‚ùå Viewer pose –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                }
                
                // Three.js camera info
                addLog('üì∑ Three.js Camera:');
                addLog(`Position: (${camera.position.x.toFixed(3)}, ${camera.position.y.toFixed(3)}, ${camera.position.z.toFixed(3)})`);
                addLog(`Rotation: (${camera.rotation.x.toFixed(3)}, ${camera.rotation.y.toFixed(3)}, ${camera.rotation.z.toFixed(3)})`);
                addLog(`Matrix World:`);
                const camMatrix = camera.matrixWorld.elements;
                for (let i = 0; i < 4; i++) {
                    const row = [];
                    for (let j = 0; j < 4; j++) {
                        row.push(camMatrix[i * 4 + j].toFixed(3));
                    }
                    addLog(`  [${row.join(', ')}]`);
                }
                
                // Objects info
                addLog('üì¶ Objects:');
                objects.forEach((item, index) => {
                    const obj = item.object;
                    const pos = obj.position;
                    const visible = obj.visible;
                    addLog(`  ${index}: ${item.name} (${pos.x.toFixed(2)}, ${pos.y.toFixed(2)}, ${pos.z.toFixed(2)}) visible=${visible}`);
                });
                
            } catch (error) {
                addLog('‚ùå –û—à–∏–±–∫–∞ matrix dump: ' + error.message);
            }
        }

        function onXRFrame(time, frame) {
            session.requestAnimationFrame(onXRFrame);
            frameCount++;
            
            // Live debug info
            try {
                const viewerPose = frame.getViewerPose(referenceSpace);
                let debugText = `Frame: ${frameCount}<br>Objects: ${objects.length}<br>`;
                
                if (viewerPose) {
                    const pos = viewerPose.transform.position;
                    debugText += `Viewer: (${pos.x.toFixed(2)}, ${pos.y.toFixed(2)}, ${pos.z.toFixed(2)})<br>`;
                    debugText += `Views: ${viewerPose.views.length}<br>`;
                } else {
                    debugText += `Viewer: –ù–ï–î–û–°–¢–£–ü–ï–ù<br>`;
                }
                
                if (renderer && renderer.info) {
                    const info = renderer.info;
                    debugText += `Calls: ${info.render.calls}<br>`;
                    debugText += `Triangles: ${info.render.triangles}<br>`;
                    debugText += `Points: ${info.render.points}<br>`;
                    debugText += `Lines: ${info.render.lines}<br>`;
                }
                
                debugInfo.innerHTML = debugText;
                
            } catch (error) {
                debugInfo.innerHTML = `Error: ${error.message}`;
            }
            
            // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥—ã–µ 60 –∫–∞–¥—Ä–æ–≤
            if (frameCount % 60 === 0) {
                addLog(`üîÑ Frame ${frameCount} - —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ ${objects.length} –æ–±—ä–µ–∫—Ç–æ–≤`);
                
                if (frameCount === 60) {
                    dumpMatrices(frame);
                }
                
                if (frameCount === 180) {
                    addLog('üîç === RENDER STATE CHECK ===');
                    addLog('Scene children: ' + scene.children.length);
                    addLog('Camera matrix auto update: ' + camera.matrixAutoUpdate);
                    addLog('Renderer auto clear: ' + renderer.autoClear);
                    addLog('Renderer sort objects: ' + renderer.sortObjects);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ –æ–±—ä–µ–∫—Ç—ã –≤ frustum
                    const frustum = new THREE.Frustum();
                    const matrix = new THREE.Matrix4().multiplyMatrices(camera.projectionMatrix, camera.matrixWorldInverse);
                    frustum.setFromProjectionMatrix(matrix);
                    
                    objects.forEach((item, index) => {
                        const inFrustum = frustum.containsPoint(item.object.position);
                        addLog(`  ${item.name}: in frustum = ${inFrustum}`);
                    });
                }
            }
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∑–∞–º–µ—Ç–Ω–æ—Å—Ç–∏
            const rotationSpeed = time * 0.001;
            objects.forEach((item, index) => {
                if (item.object && item.object.rotation && item.type !== 'helper') {
                    item.object.rotation.x = rotationSpeed * (index + 1);
                    item.object.rotation.y = rotationSpeed * (index + 1) * 1.5;
                }
            });
            
            try {
                renderer.render(scene, camera);
            } catch (error) {
                if (frameCount < 5) {
                    addLog('‚ùå –û–®–ò–ë–ö–ê –†–ï–ù–î–ï–†–ò–ù–ì–ê: ' + error.message);
                }
            }
        }

        function setupControls() {
            document.getElementById('dump-matrices').addEventListener('click', function() {
                if (frameCount > 0) {
                    addLog('üßÆ Manual matrix dump requested...');
                    // –ë—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–º frame
                }
            });
            
            document.getElementById('test-render').addEventListener('click', function() {
                addLog('üé® Testing non-XR render...');
                // –°–æ–∑–¥–∞–µ–º –æ–±—ã—á–Ω—É—é —Å—Ü–µ–Ω—É –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                testNonXRRender();
            });
            
            document.getElementById('toggle-wireframe').addEventListener('click', function() {
                wireframeMode = !wireframeMode;
                objects.forEach(item => {
                    if (item.object && item.object.material) {
                        item.object.material.wireframe = wireframeMode;
                    }
                });
                addLog(`üî≤ Wireframe mode: ${wireframeMode ? 'ON' : 'OFF'}`);
            });
        }

        function testNonXRRender() {
            addLog('üé® === NON-XR RENDER TEST ===');
            
            try {
                // –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º XR
                const tempRenderer = new THREE.WebGLRenderer({ alpha: true });
                tempRenderer.setSize(300, 300);
                
                const tempScene = new THREE.Scene();
                const tempCamera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
                tempCamera.position.z = 2;
                
                const tempLight = new THREE.AmbientLight(0xffffff, 1);
                tempScene.add(tempLight);
                
                const tempCube = new THREE.Mesh(
                    new THREE.BoxGeometry(1, 1, 1),
                    new THREE.MeshBasicMaterial({ color: 0xff0000 })
                );
                tempScene.add(tempCube);
                
                tempRenderer.render(tempScene, tempCamera);
                
                addLog('‚úÖ Non-XR render —É—Å–ø–µ—à–µ–Ω - Three.js —Ä–∞–±–æ—Ç–∞–µ—Ç');
                addLog('üîß –ü—Ä–æ–±–ª–µ–º–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞ –¥–ª—è XR —Ä–µ–∂–∏–º–∞');
                
                // –û—á–∏—Å—Ç–∫–∞
                tempRenderer.dispose();
                
            } catch (error) {
                addLog('‚ùå Non-XR render failed: ' + error.message);
                addLog('üîß –ü—Ä–æ–±–ª–µ–º–∞ –≤ —Å–∞–º–æ–º Three.js –∏–ª–∏ WebGL');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('start-btn').addEventListener('click', startMatrixDebug);
            addLog('üßÆ Matrix Debug –≥–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É');
            addLog('üéØ –ü–æ–∫–∞–∂–µ–º –í–°–Æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö –∏ –º–∞—Ç—Ä–∏—Ü–∞—Ö');
        });
    </script>
</body>
</html>