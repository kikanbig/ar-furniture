<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè¢ Professional WebXR AR | –ú–µ–±–µ–ª—å</title>
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
    
    <!-- WebXR Meta -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Three.js —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏ -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.157.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.157.0/examples/jsm/"
            }
        }
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
        }
        
        .ar-interface {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            pointer-events: none;
        }
        
        .debug-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            pointer-events: auto;
            z-index: 1001;
        }
        
        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            pointer-events: auto;
            z-index: 1001;
        }
        
        .btn {
            padding: 12px 18px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            min-width: 100px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #FF6B35, #F7931E);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #f44336, #e91e63);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .reticle-info {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            text-align: center;
            pointer-events: none;
            z-index: 1002;
        }
        
        .hidden {
            display: none;
        }
        
        .starting-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 2000;
        }
        
        .start-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            max-width: 400px;
        }
        
        .start-btn {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω -->
    <div id="starting-screen" class="starting-screen">
        <div class="start-card">
            <h1>üè¢ Professional WebXR AR</h1>
            <p style="margin: 10px 0 20px; opacity: 0.8;">
                –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ AR —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –º–µ–±–µ–ª–∏ —Å WebXR Hit Testing API
            </p>
            <button id="start-btn" class="start-btn">
                üöÄ –ó–ê–ü–£–°–¢–ò–¢–¨ PROFESSIONAL AR
            </button>
        </div>
    </div>

    <!-- AR –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div id="ar-interface" class="ar-interface hidden">
        <!-- –ü–∞–Ω–µ–ª—å –æ—Ç–ª–∞–¥–∫–∏ -->
        <div id="debug-panel" class="debug-panel">
            <div>üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Professional WebXR AR...</div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ reticle -->
        <div id="reticle-info" class="reticle-info hidden">
            üéØ –ù–∞–π–¥–µ–Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å! –ö–∞—Å–∞–π—Ç–µ—Å—å —ç–∫—Ä–∞–Ω–∞ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div id="controls" class="controls">
            <button id="place-btn" class="btn btn-success">üéØ –†–ê–ó–ú–ï–°–¢–ò–¢–¨</button>
            <button id="model-btn" class="btn btn-secondary">üõãÔ∏è CANNOLI</button>
            <button id="clear-btn" class="btn btn-danger">üóëÔ∏è –û–ß–ò–°–¢–ò–¢–¨</button>
            <button id="exit-btn" class="btn btn-primary">‚ùå –í–´–•–û–î</button>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let session = null;
        let renderer = null;
        let scene = null;
        let camera = null;
        let hitTestSource = null;
        let referenceSpace = null;
        let reticle = null;
        let placedObjects = [];
        let currentModel = 'cannoli';
        let modelTemplate = null;
        let availableModels = ['cannoli', 'bellagio', 'chair-modern'];
        let currentModelIndex = 0;
        
        const debugPanel = document.getElementById('debug-panel');
        const reticleInfo = document.getElementById('reticle-info');
        const arInterface = document.getElementById('ar-interface');
        const startingScreen = document.getElementById('starting-screen');

        // –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        function log(message) {
            console.log(message);
            debugPanel.innerHTML += '<br>' + message;
            debugPanel.scrollTop = debugPanel.scrollHeight;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AR
        async function initializeAR() {
            const startBtn = document.getElementById('start-btn');
            startBtn.disabled = true;
            startBtn.innerHTML = 'üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ WebXR...';

            try {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ WebXR
                if (!navigator.xr) {
                    throw new Error('WebXR –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —ç—Ç–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º');
                }

                log('‚úÖ WebXR API –Ω–∞–π–¥–µ–Ω');

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ immersive-ar
                const arSupported = await navigator.xr.isSessionSupported('immersive-ar');
                if (!arSupported) {
                    throw new Error('AR —Ä–µ–∂–∏–º –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —ç—Ç–∏–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º');
                }

                log('‚úÖ AR —Ä–µ–∂–∏–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                startBtn.innerHTML = 'üöÄ –ó–∞–ø—É—Å–∫ AR —Å–µ—Å—Å–∏–∏...';

                // –ó–∞–ø—Ä–æ—Å AR —Å–µ—Å—Å–∏–∏
                session = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['local', 'hit-test'],
                    optionalFeatures: ['dom-overlay'],
                    domOverlay: { root: arInterface }
                });

                log('‚úÖ AR —Å–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞');

                // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ AR –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                startingScreen.classList.add('hidden');
                arInterface.classList.remove('hidden');

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
                await initializeRenderer();
                
                // –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ü–µ–Ω—ã
                createScene();
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏
                await loadModel(currentModel);
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Hit Testing
                await setupHitTesting();
                
                // –ó–∞–ø—É—Å–∫ —Ä–µ–Ω–¥–µ—Ä –ª—É–ø–∞
                session.requestAnimationFrame(onXRFrame);
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤
                setupControls();
                
                log('üéâ Professional WebXR AR –≥–æ—Ç–æ–≤!');
                log('üîç –î–≤–∏–≥–∞–π—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–µ–π');
                
                // –°–∫—Ä—ã—Ç—å –æ—Ç–ª–∞–¥–∫—É —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    debugPanel.style.display = 'none';
                }, 5000);

            } catch (error) {
                log(`‚ùå –û–®–ò–ë–ö–ê: ${error.message}`);
                startBtn.disabled = false;
                startBtn.innerHTML = 'üöÄ –ó–ê–ü–£–°–¢–ò–¢–¨ PROFESSIONAL AR';
                
                if (error.message.includes('–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è')) {
                    log('üí° –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ:');
                    log('‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Chrome/Edge 81+ –Ω–∞ Android');
                    log('‚Ä¢ –í–∫–ª—é—á–µ–Ω—ã —Ñ–ª–∞–≥–∏ WebXR –≤ chrome://flags/');
                    log('‚Ä¢ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç ARCore');
                }
            }
        }

        // –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π
        document.addEventListener('DOMContentLoaded', () => {
            const startBtn = document.getElementById('start-btn');
            startBtn.addEventListener('click', initializeAR);
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–µ—Ä–∞
        async function initializeRenderer() {
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl', { xrCompatible: true });
            
            renderer = new THREE.WebGLRenderer({
                canvas: canvas,
                context: gl,
                alpha: true,
                antialias: true
            });
            
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.xr.enabled = true;
            renderer.xr.setSession(session);
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–Ω–µ–π
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            await session.updateRenderState({
                baseLayer: new XRWebGLLayer(session, gl)
            });
            
            log('‚úÖ WebGL —Ä–µ–Ω–¥–µ—Ä–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ü–µ–Ω—ã
        function createScene() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera();
            
            // –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(1, 4, 2);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);
            
            // –°–æ–∑–¥–∞–Ω–∏–µ reticle
            const reticleGeometry = new THREE.RingGeometry(0.15, 0.2, 32).rotateX(-Math.PI / 2);
            const reticleMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff });
            reticle = new THREE.Mesh(reticleGeometry, reticleMaterial);
            reticle.matrixAutoUpdate = false;
            reticle.visible = false;
            scene.add(reticle);
            
            log('‚úÖ 3D —Å—Ü–µ–Ω–∞ —Å–æ–∑–¥–∞–Ω–∞');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏
        async function loadModel(modelName) {
            return new Promise((resolve, reject) => {
                const loader = new GLTFLoader();
                
                log(`üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ ${modelName}...`);
                
                loader.load(
                    `/models/${modelName}-sofa.glb`,
                    (gltf) => {
                        modelTemplate = gltf.scene.clone();
                        modelTemplate.scale.set(0.4, 0.4, 0.4);
                        
                        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
                        modelTemplate.traverse((child) => {
                            if (child.isMesh) {
                                child.castShadow = true;
                                child.receiveShadow = true;
                                if (child.material) {
                                    child.material.envMapIntensity = 0.8;
                                }
                            }
                        });
                        
                        log(`‚úÖ –ú–æ–¥–µ–ª—å ${modelName} –∑–∞–≥—Ä—É–∂–µ–Ω–∞`);
                        resolve();
                    },
                    (progress) => {
                        const percent = Math.round((progress.loaded / progress.total) * 100);
                        if (percent % 25 === 0) {
                            log(`üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ ${modelName}: ${percent}%`);
                        }
                    },
                    (error) => {
                        log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${modelName}, —Å–æ–∑–¥–∞–µ–º fallback`);
                        createFallbackModel(modelName);
                        resolve();
                    }
                );
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–π –º–æ–¥–µ–ª–∏
        function createFallbackModel(modelName) {
            const geometry = new THREE.BoxGeometry(0.8, 0.4, 0.4);
            const color = modelName === 'cannoli' ? 0x8B4513 : 0x654321;
            const material = new THREE.MeshPhongMaterial({ color: color });
            modelTemplate = new THREE.Mesh(geometry, material);
            modelTemplate.castShadow = true;
            log(`üîß –°–æ–∑–¥–∞–Ω–∞ –ø—Ä–æ—Å—Ç–∞—è –º–æ–¥–µ–ª—å ${modelName}`);
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Hit Testing
        async function setupHitTesting() {
            try {
                referenceSpace = await session.requestReferenceSpace('local');
                log('‚úÖ Local reference space –ø–æ–ª—É—á–µ–Ω');
                
                const viewerSpace = await session.requestReferenceSpace('viewer');
                hitTestSource = await session.requestHitTestSource({ space: viewerSpace });
                log('‚úÖ Hit test source —Å–æ–∑–¥–∞–Ω');
                
            } catch (error) {
                log(`‚ö†Ô∏è Hit testing –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${error.message}`);
            }
        }

        // –û—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–Ω–¥–µ—Ä –ª—É–ø
        function onXRFrame(time, frame) {
            session.requestAnimationFrame(onXRFrame);
            
            // Hit testing
            if (hitTestSource && referenceSpace) {
                const hitTestResults = frame.getHitTestResults(hitTestSource);
                
                if (hitTestResults.length > 0) {
                    const hit = hitTestResults[0];
                    const pose = hit.getPose(referenceSpace);
                    
                    if (pose) {
                        reticle.visible = true;
                        reticle.matrix.fromArray(pose.transform.matrix);
                        
                        if (reticleInfo.classList.contains('hidden')) {
                            reticleInfo.classList.remove('hidden');
                        }
                    }
                } else {
                    reticle.visible = false;
                    if (!reticleInfo.classList.contains('hidden')) {
                        reticleInfo.classList.add('hidden');
                    }
                }
            }
            
            renderer.render(scene, camera);
        }

        // –†–∞–∑–º–µ—â–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞
        function placeObject(matrix = null) {
            if (!modelTemplate) {
                log('‚ö†Ô∏è –ú–æ–¥–µ–ª—å –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
                return;
            }
            
            const object = modelTemplate.clone();
            
            if (matrix && reticle.visible) {
                // –†–∞–∑–º–µ—â–µ–Ω–∏–µ –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏
                object.matrix.fromArray(matrix);
                object.matrixAutoUpdate = false;
                log('üéØ –û–±—ä–µ–∫—Ç —Ä–∞–∑–º–µ—â–µ–Ω –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏');
            } else {
                // –†–∞–∑–º–µ—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –∫–∞–º–µ—Ä–æ–π
                object.position.set(0, -0.5, -2);
                object.matrixAutoUpdate = true;
                log('üéØ –û–±—ä–µ–∫—Ç —Ä–∞–∑–º–µ—â–µ–Ω –ø–µ—Ä–µ–¥ –∫–∞–º–µ—Ä–æ–π');
            }
            
            scene.add(object);
            placedObjects.push(object);
            
            log(`üì¶ –†–∞–∑–º–µ—â–µ–Ω–æ –æ–±—ä–µ–∫—Ç–æ–≤: ${placedObjects.length}`);
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤
        function setupControls() {
            // –†–∞–∑–º–µ—â–µ–Ω–∏–µ –ø–æ –∫–∞—Å–∞–Ω–∏—é
            session.addEventListener('select', (event) => {
                if (reticle.visible) {
                    placeObject(reticle.matrix.elements);
                }
            });

            // –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
            document.getElementById('place-btn').onclick = () => {
                placeObject();
            };

            // –°–º–µ–Ω–∞ –º–æ–¥–µ–ª–∏
            document.getElementById('model-btn').onclick = async () => {
                currentModel = currentModel === 'cannoli' ? 'bellagio' : 'cannoli';
                const btn = document.getElementById('model-btn');
                btn.innerHTML = `üõãÔ∏è ${currentModel.toUpperCase()}`;
                
                await loadModel(currentModel);
                log(`üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –Ω–∞ ${currentModel}`);
            };

            // –û—á–∏—Å—Ç–∫–∞
            document.getElementById('clear-btn').onclick = () => {
                placedObjects.forEach(obj => scene.remove(obj));
                placedObjects = [];
                log('üóëÔ∏è –í—Å–µ –æ–±—ä–µ–∫—Ç—ã —É–¥–∞–ª–µ–Ω—ã');
            };

            // –í—ã—Ö–æ–¥
            document.getElementById('exit-btn').onclick = () => {
                session.end();
            };

            // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
            session.addEventListener('end', () => {
                startingScreen.classList.remove('hidden');
                arInterface.classList.add('hidden');
                log('üîö AR —Å–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
            });
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', async () => {
            if (navigator.xr) {
                try {
                    const supported = await navigator.xr.isSessionSupported('immersive-ar');
                    console.log('WebXR AR –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è:', supported);
                } catch (e) {
                    console.log('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ WebXR:', e);
                }
            } else {
                console.log('WebXR –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            }
        });
    </script>
</body>
</html>