<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü™ë AR –ö—Ä–µ—Å–ª–æ | –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å</title>
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
    
    <!-- WebXR Meta -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Three.js —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏ -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.157.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.157.0/examples/jsm/"
            }
        }
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
        }
        
        .ar-interface {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            pointer-events: none;
        }
        
        .debug-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            pointer-events: auto;
            z-index: 1001;
        }
        
        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            pointer-events: auto;
            z-index: 1001;
        }
        
        .btn {
            padding: 12px 18px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            min-width: 100px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #8B4513, #CD853F);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #f44336, #e91e63);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .reticle-info {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(139, 69, 19, 0.8);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            text-align: center;
            pointer-events: none;
            z-index: 1002;
            border: 2px solid #CD853F;
        }
        
        .hidden {
            display: none;
        }
        
        .starting-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #8B4513 0%, #CD853F 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 2000;
        }
        
        .start-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            max-width: 400px;
        }
        
        .start-btn {
            background: linear-gradient(45deg, #8B4513, #CD853F);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            box-shadow: 0 8px 20px rgba(139, 69, 19, 0.3);
        }
        
        .features {
            list-style: none;
            margin-top: 20px;
            text-align: left;
        }
        
        .features li {
            padding: 8px 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .features li:before {
            content: "ü™ë ";
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <!-- –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω -->
    <div id="starting-screen" class="starting-screen">
        <div class="start-card">
            <h1>ü™ë AR –ö—Ä–µ—Å–ª–æ Modern</h1>
            <p style="margin: 10px 0 20px; opacity: 0.8;">
                –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –∫—Ä–µ—Å–ª–æ –≤ –¥–æ–ø–æ–ª–Ω–µ–Ω–Ω–æ–π —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏
            </p>
            <button id="start-btn" class="start-btn">
                üöÄ –ó–ê–ü–£–°–¢–ò–¢–¨ AR –ö–†–ï–°–õ–û
            </button>
            
            <ul class="features">
                <li>–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è 3D –º–æ–¥–µ–ª—å</li>
                <li>–†–µ–∞–ª—å–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—è—Ö</li>
                <li>Professional WebXR —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è</li>
                <li>–¢–æ—á–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</li>
                <li>–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ</li>
            </ul>
        </div>
    </div>

    <!-- AR –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div id="ar-interface" class="ar-interface hidden">
        <!-- –ü–∞–Ω–µ–ª—å –æ—Ç–ª–∞–¥–∫–∏ -->
        <div id="debug-panel" class="debug-panel">
            <div>ü™ë –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AR –ö—Ä–µ—Å–ª–∞...</div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ reticle -->
        <div id="reticle-info" class="reticle-info hidden">
            üéØ –ù–∞–π–¥–µ–Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å! –ö–∞—Å–∞–π—Ç–µ—Å—å —ç–∫—Ä–∞–Ω–∞ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∫—Ä–µ—Å–ª–∞
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div id="controls" class="controls">
            <button id="place-btn" class="btn btn-success">ü™ë –†–ê–ó–ú–ï–°–¢–ò–¢–¨</button>
            <button id="clear-btn" class="btn btn-danger">üóëÔ∏è –û–ß–ò–°–¢–ò–¢–¨</button>
            <button id="exit-btn" class="btn btn-primary">‚ùå –í–´–•–û–î</button>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let session = null;
        let renderer = null;
        let scene = null;
        let camera = null;
        let hitTestSource = null;
        let referenceSpace = null;
        let reticle = null;
        let placedObjects = [];
        let chairTemplate = null;
        
        const debugPanel = document.getElementById('debug-panel');
        const reticleInfo = document.getElementById('reticle-info');
        const arInterface = document.getElementById('ar-interface');
        const startingScreen = document.getElementById('starting-screen');

        // –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        function log(message) {
            console.log(message);
            debugPanel.innerHTML += '<br>' + message;
            debugPanel.scrollTop = debugPanel.scrollHeight;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AR
        async function initializeAR() {
            const startBtn = document.getElementById('start-btn');
            startBtn.disabled = true;
            startBtn.innerHTML = 'üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ WebXR...';

            try {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ WebXR
                if (!navigator.xr) {
                    throw new Error('WebXR –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —ç—Ç–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º');
                }

                log('‚úÖ WebXR API –Ω–∞–π–¥–µ–Ω');

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ immersive-ar
                const arSupported = await navigator.xr.isSessionSupported('immersive-ar');
                if (!arSupported) {
                    throw new Error('AR —Ä–µ–∂–∏–º –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —ç—Ç–∏–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º');
                }

                log('‚úÖ AR —Ä–µ–∂–∏–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                startBtn.innerHTML = 'üöÄ –ó–∞–ø—É—Å–∫ AR —Å–µ—Å—Å–∏–∏...';

                // –ó–∞–ø—Ä–æ—Å AR —Å–µ—Å—Å–∏–∏
                session = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['local', 'hit-test'],
                    optionalFeatures: ['dom-overlay'],
                    domOverlay: { root: arInterface }
                });

                log('‚úÖ AR —Å–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞');

                // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ AR –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                startingScreen.classList.add('hidden');
                arInterface.classList.remove('hidden');

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
                await initializeRenderer();
                
                // –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ü–µ–Ω—ã
                createScene();
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –∫—Ä–µ—Å–ª–∞
                await loadChair();
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Hit Testing
                await setupHitTesting();
                
                // –ó–∞–ø—É—Å–∫ —Ä–µ–Ω–¥–µ—Ä –ª—É–ø–∞
                session.requestAnimationFrame(onXRFrame);
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤
                setupControls();
                
                log('ü™ë AR –ö—Ä–µ—Å–ª–æ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é!');
                log('üîç –î–≤–∏–≥–∞–π—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–µ–π');
                
                // –°–∫—Ä—ã—Ç—å –æ—Ç–ª–∞–¥–∫—É —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    debugPanel.style.display = 'none';
                }, 5000);

            } catch (error) {
                log(`‚ùå –û–®–ò–ë–ö–ê: ${error.message}`);
                startBtn.disabled = false;
                startBtn.innerHTML = 'üöÄ –ó–ê–ü–£–°–¢–ò–¢–¨ AR –ö–†–ï–°–õ–û';
                
                if (error.message.includes('–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è')) {
                    log('üí° –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ:');
                    log('‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Chrome/Edge 81+ –Ω–∞ Android');
                    log('‚Ä¢ –í–∫–ª—é—á–µ–Ω—ã —Ñ–ª–∞–≥–∏ WebXR –≤ chrome://flags/');
                    log('‚Ä¢ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç ARCore');
                }
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±—Ä–∞—É–∑–µ—Ä–∞
        function checkBrowser() {
            const userAgent = navigator.userAgent.toLowerCase();
            const isTelegram = userAgent.includes('telegram');
            const isWhatsApp = userAgent.includes('whatsapp');
            const isViber = userAgent.includes('viber');
            const isInApp = isTelegram || isWhatsApp || isViber;
            
            if (isInApp) {
                const browserName = isTelegram ? 'Telegram' : isWhatsApp ? 'WhatsApp' : 'Viber';
                log(`‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω –±—Ä–∞—É–∑–µ—Ä ${browserName}!`);
                log('üí° –î–ª—è AR –Ω—É–∂–µ–Ω Chrome/Safari');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                const warning = document.createElement('div');
                warning.style.cssText = `
                    position: fixed; top: 10px; left: 10px; right: 10px; z-index: 9999;
                    background: linear-gradient(45deg, #ff6b6b, #ee5a5a);
                    color: white; padding: 15px; border-radius: 10px;
                    text-align: center; font-size: 14px; font-weight: bold;
                `;
                warning.innerHTML = `
                    ‚ö†Ô∏è ${browserName} –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç AR<br>
                    üì± –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É –≤ Chrome –¥–ª—è —Ä–∞–±–æ—Ç—ã AR
                `;
                document.body.appendChild(warning);
                
                return false;
            }
            
            return true;
        }

        // –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π
        document.addEventListener('DOMContentLoaded', () => {
            const startBtn = document.getElementById('start-btn');
            startBtn.addEventListener('click', initializeAR);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±—Ä–∞—É–∑–µ—Ä
            checkBrowser();
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–µ—Ä–∞
        async function initializeRenderer() {
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl', { xrCompatible: true });
            
            renderer = new THREE.WebGLRenderer({
                canvas: canvas,
                context: gl,
                alpha: true,
                antialias: true
            });
            
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.xr.enabled = true;
            renderer.xr.setSession(session);
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–Ω–µ–π
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            await session.updateRenderState({
                baseLayer: new XRWebGLLayer(session, gl)
            });
            
            log('‚úÖ WebGL —Ä–µ–Ω–¥–µ—Ä–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ü–µ–Ω—ã
        function createScene() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera();
            
            // –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ –¥–ª—è –∫—Ä–µ—Å–ª–∞
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(2, 4, 3);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ —Å–±–æ–∫—É
            const sideLight = new THREE.DirectionalLight(0xffffff, 0.3);
            sideLight.position.set(-2, 2, 1);
            scene.add(sideLight);
            
            // –°–æ–∑–¥–∞–Ω–∏–µ reticle (–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –¥–ª—è –∫—Ä–µ—Å–ª–∞)
            const reticleGeometry = new THREE.RingGeometry(0.1, 0.15, 32).rotateX(-Math.PI / 2);
            const reticleMaterial = new THREE.MeshBasicMaterial({ 
                color: 0xCD853F,
                transparent: true,
                opacity: 0.8
            });
            reticle = new THREE.Mesh(reticleGeometry, reticleMaterial);
            reticle.matrixAutoUpdate = false;
            reticle.visible = false;
            scene.add(reticle);
            
            log('‚úÖ 3D —Å—Ü–µ–Ω–∞ —Å–æ–∑–¥–∞–Ω–∞');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫—Ä–µ—Å–ª–∞
        async function loadChair() {
            return new Promise((resolve, reject) => {
                const loader = new GLTFLoader();
                
                log('ü™ë –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∫—Ä–µ—Å–ª–∞...');
                
                loader.load(
                    '/models/chair-modern.glb',
                    (gltf) => {
                        chairTemplate = gltf.scene.clone();
                        
                        // –ü–æ–¥—Ö–æ–¥—è—â–∏–π —Ä–∞–∑–º–µ—Ä –¥–ª—è –∫—Ä–µ—Å–ª–∞
                        chairTemplate.scale.set(0.5, 0.5, 0.5);
                        
                        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
                        chairTemplate.traverse((child) => {
                            if (child.isMesh) {
                                child.castShadow = true;
                                child.receiveShadow = true;
                                if (child.material) {
                                    child.material.envMapIntensity = 0.8;
                                    // –£–ª—É—á—à–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∫—Ä–µ—Å–ª–∞
                                    if (child.material.map) {
                                        child.material.map.anisotropy = renderer.capabilities.getMaxAnisotropy();
                                    }
                                }
                            }
                        });
                        
                        log('‚úÖ –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –∫—Ä–µ—Å–ª–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!');
                        resolve();
                    },
                    (progress) => {
                        const percent = Math.round((progress.loaded / progress.total) * 100);
                        if (percent % 25 === 0) {
                            log(`ü™ë –ó–∞–≥—Ä—É–∑–∫–∞ –∫—Ä–µ—Å–ª–∞: ${percent}%`);
                        }
                    },
                    (error) => {
                        log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—Ä–µ—Å–ª–∞, —Å–æ–∑–¥–∞–µ–º fallback');
                        createFallbackChair();
                        resolve();
                    }
                );
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–≥–æ –∫—Ä–µ—Å–ª–∞
        function createFallbackChair() {
            const group = new THREE.Group();
            
            // –°–∏–¥–µ–Ω—å–µ
            const seatGeometry = new THREE.BoxGeometry(0.6, 0.1, 0.6);
            const seatMaterial = new THREE.MeshPhongMaterial({ color: 0x8B4513 });
            const seat = new THREE.Mesh(seatGeometry, seatMaterial);
            seat.position.y = 0.4;
            seat.castShadow = true;
            group.add(seat);
            
            // –°–ø–∏–Ω–∫–∞
            const backGeometry = new THREE.BoxGeometry(0.6, 0.6, 0.1);
            const backMaterial = new THREE.MeshPhongMaterial({ color: 0x654321 });
            const back = new THREE.Mesh(backGeometry, backMaterial);
            back.position.set(0, 0.7, -0.25);
            back.castShadow = true;
            group.add(back);
            
            // –ù–æ–∂–∫–∏
            const legGeometry = new THREE.CylinderGeometry(0.03, 0.03, 0.4);
            const legMaterial = new THREE.MeshPhongMaterial({ color: 0x2F2F2F });
            
            const positions = [
                [-0.25, 0.2, -0.25],
                [0.25, 0.2, -0.25],
                [-0.25, 0.2, 0.25],
                [0.25, 0.2, 0.25]
            ];
            
            positions.forEach(pos => {
                const leg = new THREE.Mesh(legGeometry, legMaterial);
                leg.position.set(pos[0], pos[1], pos[2]);
                leg.castShadow = true;
                group.add(leg);
            });
            
            chairTemplate = group;
            log('üîß –°–æ–∑–¥–∞–Ω–æ –ø—Ä–æ—Å—Ç–æ–µ –∫—Ä–µ—Å–ª–æ');
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Hit Testing
        async function setupHitTesting() {
            try {
                referenceSpace = await session.requestReferenceSpace('local');
                log('‚úÖ Local reference space –ø–æ–ª—É—á–µ–Ω');
                
                const viewerSpace = await session.requestReferenceSpace('viewer');
                hitTestSource = await session.requestHitTestSource({ space: viewerSpace });
                log('‚úÖ Hit test source —Å–æ–∑–¥–∞–Ω');
                
            } catch (error) {
                log(`‚ö†Ô∏è Hit testing –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${error.message}`);
            }
        }

        // –û—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–Ω–¥–µ—Ä –ª—É–ø
        function onXRFrame(time, frame) {
            session.requestAnimationFrame(onXRFrame);
            
            // Hit testing
            if (hitTestSource && referenceSpace) {
                const hitTestResults = frame.getHitTestResults(hitTestSource);
                
                if (hitTestResults.length > 0) {
                    const hit = hitTestResults[0];
                    const pose = hit.getPose(referenceSpace);
                    
                    if (pose) {
                        reticle.visible = true;
                        reticle.matrix.fromArray(pose.transform.matrix);
                        
                        if (reticleInfo.classList.contains('hidden')) {
                            reticleInfo.classList.remove('hidden');
                        }
                    }
                } else {
                    reticle.visible = false;
                    if (!reticleInfo.classList.contains('hidden')) {
                        reticleInfo.classList.add('hidden');
                    }
                }
            }
            
            renderer.render(scene, camera);
        }

        // –†–∞–∑–º–µ—â–µ–Ω–∏–µ –∫—Ä–µ—Å–ª–∞
        function placeChair(matrix = null) {
            if (!chairTemplate) {
                log('‚ö†Ô∏è –ö—Ä–µ—Å–ª–æ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
                return;
            }
            
            const chair = chairTemplate.clone();
            
            if (matrix && reticle.visible) {
                // –†–∞–∑–º–µ—â–µ–Ω–∏–µ –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏
                chair.matrix.fromArray(matrix);
                chair.matrixAutoUpdate = false;
                log('ü™ë –ö—Ä–µ—Å–ª–æ —Ä–∞–∑–º–µ—â–µ–Ω–æ –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏');
            } else {
                // –†–∞–∑–º–µ—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –∫–∞–º–µ—Ä–æ–π
                chair.position.set(0, -0.3, -1.5);
                chair.matrixAutoUpdate = true;
                log('ü™ë –ö—Ä–µ—Å–ª–æ —Ä–∞–∑–º–µ—â–µ–Ω–æ –ø–µ—Ä–µ–¥ –∫–∞–º–µ—Ä–æ–π');
            }
            
            scene.add(chair);
            placedObjects.push(chair);
            
            log(`ü™ë –†–∞–∑–º–µ—â–µ–Ω–æ –∫—Ä–µ—Å–µ–ª: ${placedObjects.length}`);
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤
        function setupControls() {
            // –†–∞–∑–º–µ—â–µ–Ω–∏–µ –ø–æ –∫–∞—Å–∞–Ω–∏—é
            session.addEventListener('select', (event) => {
                if (reticle.visible) {
                    placeChair(reticle.matrix.elements);
                }
            });

            // –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
            document.getElementById('place-btn').onclick = () => {
                placeChair();
            };

            // –û—á–∏—Å—Ç–∫–∞
            document.getElementById('clear-btn').onclick = () => {
                placedObjects.forEach(obj => scene.remove(obj));
                placedObjects = [];
                log('üóëÔ∏è –í—Å–µ –∫—Ä–µ—Å–ª–∞ —É–¥–∞–ª–µ–Ω—ã');
            };

            // –í—ã—Ö–æ–¥
            document.getElementById('exit-btn').onclick = () => {
                session.end();
            };

            // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
            session.addEventListener('end', () => {
                startingScreen.classList.remove('hidden');
                arInterface.classList.add('hidden');
                log('üîö AR —Å–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
            });
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', async () => {
            if (navigator.xr) {
                try {
                    const supported = await navigator.xr.isSessionSupported('immersive-ar');
                    console.log('WebXR AR –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è:', supported);
                } catch (e) {
                    console.log('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ WebXR:', e);
                }
            } else {
                console.log('WebXR –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            }
        });
    </script>
</body>
</html>